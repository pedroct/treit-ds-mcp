# syntax=docker/dockerfile:1

FROM node:20-alpine AS deps
WORKDIR /app
COPY mcp/package.json mcp/package-lock.json ./mcp/
RUN cd mcp && npm ci

FROM node:20-alpine AS builder
WORKDIR /app
COPY --from=deps /app/mcp/node_modules ./mcp/node_modules
COPY mcp ./mcp
RUN cd mcp && npm run build

FROM node:20-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV MCP_HTTP_PORT=8787

# Runtime tools for healthcheck
RUN apk add --no-cache curl

# Non-root user
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

# MCP server runtime
COPY --from=builder /app/mcp/package.json /app/mcp/package-lock.json ./mcp/
COPY --from=builder /app/mcp/dist ./mcp/dist
COPY --from=builder /app/mcp/node_modules ./mcp/node_modules

# Design system source-of-truth files
COPY tailwind.config.ts ./tailwind.config.ts
COPY README.md ./README.md
COPY DESIGN_CONTEXT.md ./DESIGN_CONTEXT.md
COPY DESIGN_SYSTEM_SETUP.md ./DESIGN_SYSTEM_SETUP.md
COPY TYPOGRAPHY_UPDATE.md ./TYPOGRAPHY_UPDATE.md
COPY components.json ./components.json
COPY src ./src

RUN chown -R appuser:appgroup /app
USER appuser

EXPOSE 8787

HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
  CMD curl -f http://localhost:8787/health || exit 1

CMD ["node", "./mcp/dist/index.js"]
