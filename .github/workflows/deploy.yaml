name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy DS Site + MCP
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Required Secrets
        run: |
          echo "üîç Validating deployment secrets..."

          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ùå Error: VPS_HOST secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "‚ùå Error: VPS_USER secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.VPS_PATH }}" ]; then
            echo "‚ùå Error: VPS_PATH secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.VPS_SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå Error: VPS_SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi

          echo "‚úÖ All required secrets are configured"
          echo "üìç VPS Host: ${{ secrets.VPS_HOST }}"
          echo "üë§ VPS User: ${{ secrets.VPS_USER }}"
          echo "üìÅ VPS Path: ${{ secrets.VPS_PATH }}"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          echo "üîç Scanning SSH keys from VPS host..."
          ssh-keyscan -T 10 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è  ssh-keyscan failed, trying with verbose output..."
            ssh-keyscan -v -T 10 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>&1 || {
              echo "‚ùå Failed to add host to known_hosts"
              echo "Testing connectivity to ${{ secrets.VPS_HOST }}:22..."
              nc -zv -w 5 ${{ secrets.VPS_HOST }} 22 || echo "Port 22 not reachable"
              exit 1
            }
          }
          echo "‚úÖ Host keys added successfully"

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: ${{ secrets.VPS_PATH }}
        run: |
          echo "üöÄ Iniciando deploy para VPS..."
          echo "üìç Destino: $VPS_USER@$VPS_HOST:$VPS_PATH"

          # Sincroniza arquivos (exclui artefatos locais)
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='**/node_modules' \
            --exclude='.next' \
            --exclude='.vscode' \
            --exclude='.env' \
            --exclude='.DS_Store' \
            ./ $VPS_USER@$VPS_HOST:$VPS_PATH/

          echo "‚úÖ Arquivos sincronizados"

          ssh $VPS_USER@$VPS_HOST << ENDSSH
            set -euxo pipefail
            cd $VPS_PATH

            echo "üê≥ Reconstruindo containers..."
            docker compose down --remove-orphans || true

            echo "üì¶ Building images..."
            docker compose build

            echo "üöÄ Starting containers..."
            docker compose up -d

            echo "‚è≥ Aguardando containers ficarem healthy..."
            timeout 120 bash -c '
              while true; do
                if docker compose ps | grep -q "ds-site.*Up" && docker compose ps | grep -q "mcp.*Up"; then
                  echo "‚úÖ Containers est√£o Up"
                  break
                fi
                echo "‚è≥ Aguardando containers..."
                sleep 3
              done
            ' || echo "‚ö†Ô∏è  Timeout aguardando containers, continuando..."

            echo "üîç Verificando status dos containers..."
            docker compose ps

            echo "üè• Testando health checks internos..."
            # Testa ds-site diretamente na porta exposta
            curl -f http://localhost:3000/ > /dev/null && echo "‚úÖ ds-site OK" || echo "‚ö†Ô∏è  ds-site falhou"

            # Testa MCP via container (porta n√£o exposta no host)
            docker exec treit-design-system-mcp-1 curl -f http://localhost:8787/health > /dev/null && echo "‚úÖ MCP OK" || echo "‚ö†Ô∏è  MCP falhou"

            # Verifica nginx-aponta (se estiver na mesma rede)
            docker exec nginx-aponta nginx -t && echo "‚úÖ nginx config OK" || echo "‚ö†Ô∏è  nginx config com problemas"

            echo "‚úÖ Deploy interno conclu√≠do!"
          ENDSSH

      - name: Verify Public Health
        run: |
          echo "üåç Verificando acesso p√∫blico (HTTPS)..."
          curl -f https://ds.treit.com.br/ > /dev/null
          curl -f https://mcp.treit.com.br/health > /dev/null
          echo "‚úÖ Servi√ßos acess√≠veis publicamente!"
